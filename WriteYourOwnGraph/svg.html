<!DOCTYPE html>
<html>
<head>
	<title>Grafos</title>
	<meta charset="utf-8"/>
	<script type="text/javascript" src="js/jquery-3.1.0.js"></script>
	<link rel="stylesheet" type="text/css" href="css/panel.css"></link>
	<link rel="stylesheet" type="text/css" href="css/tools.css"></link>
</head>
<body>
	<div id="idPanelTools">
		<div class="tool">
			<img id="idDot" src="images/dot.png" />			
		</div>
		<div class="tool">
			<img id="idEdge" src="images/line_chart.png" />
		</div>
	</div>
	
	<div id="idPanelDashboard">
		<svg id="idDashboard">			
	  		<!-- <circle id="pointA" cx="15" cy="15" r="5" stroke="black" stroke-width="4" fill="black" />
	  		<circle id="pointB" cx="250" cy="250" r="5" stroke="black" stroke-width="4" fill="black" />	  		

	  		<path id="pathAB" d="M15,15 L250,250" stroke="red" stroke-width="3"/>
	  		<path id="recursive" d="M100,200 C100,100 250,100 110,200" stroke="red" stroke-width="3" fill="none" /> -->	  		
		</svg>	
	</div>
	
	<div id="idPanelLayers">
		<div id="idLayers"></div>
	</div>
</body>
<script type="text/javascript">
	var axisX=0, axisY=0;
	var $dashboard = $('#idDashboard');
	var leftPositionDashboard = $dashboard.position().left;
	var topPositionDashboard = $dashboard.position().top;
	var flagAction = '';
	var $dot;
	var pickedDots = new Array();
	var $divLayers = $('#idLayers');
	var MSG_DOT_CREATION = "Criação de nó";
	var MSG_EDGE_CREATION = "Criação de aresta";

	$(document).ready(function() {
		$dashboard.mousemove(function(event) {
			axisX=event.pageX;
			axisY=event.pageY;			

			if(flagAction=='drawDot'){				
				$dot.attr('cx',axisX-leftPositionDashboard);
				$dot.attr('cy',axisY-topPositionDashboard);
			}
		});

		$dashboard.click(function(event) {
			if(flagAction=='drawDot'){
				$dashboard.append($dot);
				createLayer(MSG_DOT_CREATION, "ddd");
				flagAction='';
			}
		});

		$('#idDot').click(function() {
			drawDot(axisX,axisY);
		});

		$('#idEdge').click(function(){
			drawEdgeValidation();
		});
	});

	function drawDot(axisX,axisY){		
		$dot = $(document.createElementNS("http://www.w3.org/2000/svg", 'circle'));
		$dot.attr('r', 5)
			.attr('stroke','black')
			.attr('stroke-width','2')
			.attr('fill','black');
		$dot.on('click',function(){
			pickAndUnpickDot($(this));
		});
		flagAction = 'drawDot';		
	}

	function pickAndUnpickDot($dot) {
		if($dot.attr('stroke')=='red'){
			$dot.attr('stroke','black');
			pickedDots.pop($dot);
		} else{
			$dot.attr('stroke','red');
			pickedDots.push($dot);
		}
	}

	function drawEdgeValidation() {
		var arrayLength = pickedDots.length;
		if(arrayLength == 0){
			alert("Sem nós para projeção de aresta.");
		} else if(arrayLength == 1){
			if(confirm("Utilização de nó recursivo ?")){
				drawRecursiveEdge(pickedDots[0], pickedDots[0]);
			}
		} else if(arrayLength > 2){
			alert("Mais de 2 nós para projeção de aresta.");
		} else {
			drawStraightEdge(pickedDots[0],pickedDots[1]);
		}
	}

	function drawStraightEdge($dotBegin, $dotEnd) {
		var d = 'M'+$dotBegin.attr('cx')+','+$dotBegin.attr('cy')+' L'+$dotEnd.attr('cx')+','+$dotEnd.attr('cy');
		var $edge = $(document.createElementNS("http://www.w3.org/2000/svg", 'path'));
		$edge.attr('stroke-width','3')
				.attr('stroke','black')
				.attr('d',d);
		$dashboard.append($edge);
		pickAndUnpickDot($dotBegin);
		pickAndUnpickDot($dotEnd);
		createLayer(MSG_EDGE_CREATION,'ddd');
	}

	function drawRecursiveEdge($dotBegin, $dotEnd) {
		
	}

	function createLayer(msg, idElement){
		var $layer = $('<div>');
		var $spanDescription = $('<span>');
		var $spanTrash = $('<span>');
		var $imgTrash = $("<img src='images/trash.png' title='Excluir' class='imgTrashLayer' />");
		
		$spanDescription.addClass('spanDescriptionLayer');
		$spanDescription.html(msg);
		$spanDescription.click(function(idElement){
			pickAndUnpickDot($('#'+idElement));
		});

		$spanTrash.addClass('spanTrashLayer');
		$spanTrash.append($imgTrash);
		
		$layer.addClass('layer');
		$layer.append($spanDescription);
		$layer.append($spanTrash);
		
		$divLayers.append($layer);
		$divLayers.prop('scrollTop', $divLayers.prop('scrollHeight'));

		$imgTrash.click(function(idElement){
			alert("fff");
			$('#'+idElement).remove();
		});
	} 
</script>
</html>